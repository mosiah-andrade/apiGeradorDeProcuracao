name: Deploy Hostinger (Appleboy SCP)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Deploy API e Front
    runs-on: ubuntu-latest
    steps:
      - name: üöö Obter c√≥digo
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. DEPLOY DA API PHP
      # ---------------------------------------------------------
      - name: üìÇ Upload API PHP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          
          # Aumentamos o tempo limite para evitar o erro de Handshake
          timeout: 120s 
          
          # Pega a pasta API-PHP
          source: "API-PHP/*"
          
          # Manda para a pasta api (SEM a barra / no in√≠cio)
          target: "public_html/api"
          
          # Remove a primeira pasta (API-PHP) para jogar apenas os arquivos dentro de public_html/api
          strip_components: 1

      # ---------------------------------------------------------
      # 2. BUILD DO FRONT-END (Next.js)
      # ---------------------------------------------------------
      - name: üì¶ Instalar Depend√™ncias
        working-directory: ./front-contratos-next
        run: npm install --legacy-peer-deps

      - name: üèóÔ∏è Build do Next.js
        working-directory: ./front-contratos-next
        env:
           NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
           NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
        run: npm run build 

      # ---------------------------------------------------------
      # 3. DEPLOY DO FRONT-END
      # ---------------------------------------------------------
      - name: üöÄ Upload Frontend
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          timeout: 120s
          
          # Pega o conte√∫do gerado
          source: "front-contratos-next/out/*"
          
          # Manda para a raiz do site (SEM a barra / no in√≠cio)
          target: "public_html"
          
          # Remove as pastas "front-contratos-next" e "out" do caminho, jogando apenas os arquivos na raiz
          strip_components: 2
          # ... (seus passos de upload anteriores) ...

      # ADICIONE ISSO NO FINAL DO ARQUIVO .YML PARA DEBUGAR
      - name: üïµÔ∏è Verificar onde os arquivos est√£o
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          script: |
            echo "---- LISTANDO RAIZ ----"
            ls -la
            echo "---- LISTANDO PUBLIC_HTML ----"
            ls -la public_html
            echo "---- PROCURANDO ARQUIVOS PERDIDOS ----"
            find . -maxdepth 3 -name "index.html"