name: Deploy para Hostinger

on:
  push:
    branches:
      - main  # Ou 'master', verifique o nome da sua branch principal

jobs:
  web-deploy:
    name: Deploy API e Front
    runs-on: ubuntu-latest
    steps:
      - name: üöö Obter c√≥digo mais recente
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. DEPLOY DA API PHP
      # Envia a pasta 'API-PHP' para 'public_html/api'
      # ---------------------------------------------------------
      - name: üìÇ Sincronizar API PHP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./API-PHP/        # Pasta local no reposit√≥rio
          server-dir: ./api/  # Onde vai ficar na Hostinger
          exclude: |
            **/.git*
            **/.git*/**

      # ---------------------------------------------------------
      # 2. BUILD E DEPLOY DO FRONT-END (Next.js)
      # Gera a pasta 'out' e envia para a raiz 'public_html'
      # ---------------------------------------------------------
      - name: üì¶ Instalar Depend√™ncias (Next.js)
        working-directory: ./front-contratos-next
        run: npm install --legacy-peer-deps

      - name: üèóÔ∏è Construir Site (Build)
        working-directory: ./front-contratos-next
        env:
          # Isso pega a vari√°vel que voc√™ criou nas configura√ß√µes do GitHub
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_API_KEY: ${{ vars.NEXT_PUBLIC_API_KEY }}
        run: npm run build # Isso vai criar a pasta 'out' automaticamente aqui

      - name: üöÄ Enviar Front-end para Hostinger
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # AQUI EST√Å O SEGREDO: Pegamos a pasta criada pelo build
          local-dir: ./front-contratos-next/out/
          server-dir: ./      # Vai para a raiz do site
          exclude: |
            **/.git*
            **/node_modules/**
            api/**
            api/**/*
            **/.git*/**