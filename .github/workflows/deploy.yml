name: Deploy Asaweb.tech (Hostinger)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Deploy API e Front
    runs-on: ubuntu-latest
    steps:
      - name: üöö Obter c√≥digo
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. DEPLOY DA API PHP
      # ---------------------------------------------------------
      - name: üìÇ Upload API PHP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          timeout: 120s
          
          # Pega todo o conte√∫do da pasta API-PHP
          source: "API-PHP/*"
          
          # Manda para a pasta espec√≠fica do dom√≠nio
          target: "domains/asaweb.tech/public_html/api"
          
          # Remove a pasta "API-PHP" do caminho para jogar apenas os arquivos
          strip_components: 1

      # ---------------------------------------------------------
      # 2. BUILD DO FRONT-END (Next.js)
      # ---------------------------------------------------------
      - name: üì¶ Instalar Depend√™ncias
        working-directory: ./front-contratos-next
        run: npm install --legacy-peer-deps

      - name: üèóÔ∏è Build do Next.js
        working-directory: ./front-contratos-next
        env:
           NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
           NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
        run: npm run build 

      # ---------------------------------------------------------
      # 3. PREPARA√á√ÉO DOS ARQUIVOS
      # ---------------------------------------------------------
      - name: üßπ Preparar pasta para envio
        run: |
          # Movemos o 'out' para 'site_deploy' para facilitar o envio
          mv front-contratos-next/out site_deploy

      # ---------------------------------------------------------
      # 4. DEPLOY DO FRONT-END
      # ---------------------------------------------------------
      - name: üöÄ Upload Frontend
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          timeout: 120s
          
          # Pega da pasta tempor√°ria
          source: "site_deploy/*"
          
          # Manda para a raiz do dom√≠nio asaweb.tech
          target: "domains/asaweb.tech/public_html"
          
          strip_components: 1

      # ---------------------------------------------------------
      # 5. CONFIRMA√á√ÉO FINAL
      # ---------------------------------------------------------
      - name: üïµÔ∏è Verificar se chegou no lugar certo
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          script: |
            echo "--- Verificando pasta do Asaweb ---"
            ls -la domains/asaweb.tech/public_html