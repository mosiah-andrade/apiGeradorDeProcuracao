name: Deploy Hostinger (Appleboy Robusto)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Deploy API e Front
    runs-on: ubuntu-latest
    steps:
      - name: üöö Obter c√≥digo
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. DEPLOY DA API PHP
      # ---------------------------------------------------------
      - name: üìÇ Upload API PHP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          timeout: 120s
          
          # Envia o conte√∫do da pasta API-PHP
          source: "API-PHP/*"
          target: "public_html/api"
          
          # Remove a pasta "API-PHP" do caminho para n√£o criar subpasta extra
          strip_components: 1

      # ---------------------------------------------------------
      # 2. BUILD DO FRONT-END (Next.js)
      # ---------------------------------------------------------
      - name: üì¶ Instalar Depend√™ncias
        working-directory: ./front-contratos-next
        run: npm install --legacy-peer-deps

      - name: üèóÔ∏è Build do Next.js
        working-directory: ./front-contratos-next
        env:
           NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
           NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
        run: npm run build 

      # ---------------------------------------------------------
      # 3. PREPARA√á√ÉO DOS ARQUIVOS (O Segredo)
      # ---------------------------------------------------------
      - name: üßπ Preparar pasta para envio
        run: |
          # Movemos o conte√∫do de 'out' para uma pasta limpa na raiz
          # Isso facilita para o SCP encontrar o caminho
          mv front-contratos-next/out site_deploy

      # ---------------------------------------------------------
      # 4. DEPLOY DO FRONT-END
      # ---------------------------------------------------------
      - name: üöÄ Upload Frontend
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          timeout: 120s
          
          # Pega da pasta que preparamos acima
          source: "site_deploy/*"
          
          # Manda para a raiz p√∫blica
          target: "public_html"
          
          # Remove a pasta 'site_deploy' e joga s√≥ os arquivos
          strip_components: 1

      # ---------------------------------------------------------
      # 5. TIRA-TEIMA (Verificar se chegou)
      # ---------------------------------------------------------
      - name: üïµÔ∏è Verificar arquivos no servidor
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 65002
          script: |
            echo "--- CONTE√öDO DA PASTA PUBLIC_HTML ---"
            ls -la public_html