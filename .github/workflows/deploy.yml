name: Deploy para Hostinger (Final)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Deploy API e Front
    runs-on: ubuntu-latest
    steps:
      - name: üöö Obter c√≥digo mais recente
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. DEPLOY DA API PHP
      # ---------------------------------------------------------
      - name: üìÇ Upload API PHP (SFTP)
        uses: wangyucode/sftp-upload-action@v2.0.4
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }} # Deve ser 65002
          
          localDir: './API-PHP'
          remoteDir: '/public_html/api'
          
          # dryRun: false # Descomente se quiser apenas testar sem enviar
          # verbose: true # Ajuda a ver erros no log se falhar

      # ---------------------------------------------------------
      # 2. BUILD DO FRONT-END (Next.js)
      # ---------------------------------------------------------
      - name: üì¶ Instalar Depend√™ncias (Next.js)
        working-directory: ./front-contratos-next
        run: npm install --legacy-peer-deps

      - name: üèóÔ∏è Construir Site (Build)
        working-directory: ./front-contratos-next
        env:
           NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
           NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
        run: npm run build 


      # ---------------------------------------------------------
      # 3. DEPLOY DO FRONT-END
      # ---------------------------------------------------------
      - name: üöÄ Upload Frontend (SFTP)
        uses: wangyucode/sftp-upload-action@v2.0.4
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }} # 65002
          
          # Aten√ß√£o: O localDir deve ser a pasta interna do 'out'
          localDir: './front-contratos-next/out'
          remoteDir: './'
          
          # IMPORTANTE: Como n√£o usamos 'clean: true', ele vai substituir 
          # os arquivos do site, mas N√ÉO vai apagar a pasta 'api' que subimos antes.